<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>JointPositionFetchingScheduler.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">Adaptor Manager</a> &gt; <a href="index.source.html" class="el_package">at.jku.swe.simcomp.manager.service.scheduler</a> &gt; <span class="el_source">JointPositionFetchingScheduler.java</span></div><h1>JointPositionFetchingScheduler.java</h1><pre class="source lang-java linenums">package at.jku.swe.simcomp.manager.service.scheduler;


import at.jku.swe.simcomp.commons.adaptor.attribute.AttributeKey;
import at.jku.swe.simcomp.commons.adaptor.attribute.AttributeValue;
import at.jku.swe.simcomp.commons.adaptor.endpoint.exception.SessionNotValidException;
import at.jku.swe.simcomp.commons.manager.dto.session.SessionState;
import at.jku.swe.simcomp.commons.registry.dto.ServiceRegistrationConfigDTO;
import at.jku.swe.simcomp.manager.domain.model.AdaptorSession;
import at.jku.swe.simcomp.manager.domain.model.JointPositions;
import at.jku.swe.simcomp.manager.domain.repository.AdaptorSessionRepository;
import at.jku.swe.simcomp.manager.service.client.AdaptorClient;
import at.jku.swe.simcomp.manager.service.client.ServiceRegistryClient;
import lombok.extern.slf4j.Slf4j;
import org.springframework.scheduling.annotation.Scheduled;
import org.springframework.stereotype.Component;

import java.util.HashMap;
import java.util.List;
import java.util.Map;
import java.util.Optional;

@Component
<span class="fc" id="L24">@Slf4j</span>
public class JointPositionFetchingScheduler {
    private final AdaptorSessionRepository adaptorSessionRepository;
    private final AdaptorClient adaptorClient;
    private final ServiceRegistryClient serviceRegistryClient;

    public JointPositionFetchingScheduler(AdaptorSessionRepository adaptorSessionRepository,
                                          AdaptorClient adaptorClient,
<span class="fc" id="L32">                                          ServiceRegistryClient serviceRegistryClient){</span>
<span class="fc" id="L33">        this.adaptorSessionRepository = adaptorSessionRepository;</span>
<span class="fc" id="L34">        this.adaptorClient = adaptorClient;</span>
<span class="fc" id="L35">        this.serviceRegistryClient = serviceRegistryClient;</span>
<span class="fc" id="L36">    }</span>

    @Scheduled(fixedRate = 30000)
    public void fetchJointPositionsForOpenAdaptorSessions(){
<span class="fc" id="L40">        log.info(&quot;Fetching joint positions for open adaptor sessions..&quot;);</span>
<span class="nc" id="L41">        List&lt;ServiceRegistrationConfigDTO&gt; adaptorConfigs = serviceRegistryClient.getRegisteredAdaptors();</span>
<span class="nc" id="L42">        List&lt;AdaptorSession&gt; openSessions = adaptorSessionRepository.findByState(SessionState.OPEN);</span>
<span class="nc" id="L43">        Map&lt;AdaptorSession, ServiceRegistrationConfigDTO&gt; sessionConfigMap = new HashMap&lt;&gt;();</span>

<span class="nc bnc" id="L45" title="All 2 branches missed.">        for (AdaptorSession session : openSessions) {</span>
<span class="nc" id="L46">            ServiceRegistrationConfigDTO matchingConfig = findMatchingConfig(session, adaptorConfigs);</span>
<span class="nc bnc" id="L47" title="All 2 branches missed.">            if (matchingConfig != null) {</span>
<span class="nc" id="L48">                sessionConfigMap.put(session, matchingConfig);</span>
            }
<span class="nc" id="L50">        }</span>

<span class="nc" id="L52">        sessionConfigMap.forEach(this::fetchJointPosition);</span>
<span class="nc" id="L53">        log.debug(&quot;Finished fetching joint positions for open adaptor sessions&quot;);</span>
<span class="nc" id="L54">    }</span>

    private ServiceRegistrationConfigDTO findMatchingConfig(AdaptorSession session, List&lt;ServiceRegistrationConfigDTO&gt; adaptorConfigs) {
<span class="nc" id="L57">        String adaptorName = session.getAdaptorName();</span>

<span class="nc bnc" id="L59" title="All 2 branches missed.">        for (ServiceRegistrationConfigDTO config : adaptorConfigs) {</span>
<span class="nc bnc" id="L60" title="All 2 branches missed.">            if (adaptorName.equals(config.getName())) {</span>
<span class="nc" id="L61">                return config;</span>
            }
<span class="nc" id="L63">        }</span>

<span class="nc" id="L65">        log.warn(&quot;No matching adaptor config found for session {} with adaptor name {}&quot;, session.getId(), adaptorName);</span>
<span class="nc" id="L66">        return null;</span>
    }

    private void fetchJointPosition(AdaptorSession session, ServiceRegistrationConfigDTO config) {
<span class="nc" id="L70">        log.info(&quot;Fetching joint positions for session {} with key {} from adaptor {}&quot;,</span>
<span class="nc" id="L71">                session.getId(), session.getSessionKey(), config.getName());</span>
        try {
<span class="nc" id="L73">            adaptorClient.getAttributeValue(session.getSessionKey(), AttributeKey.JOINT_POSITIONS, config)</span>
<span class="nc" id="L74">                    .ifPresent(attributeValue -&gt; {</span>
<span class="nc bnc" id="L75" title="All 2 branches missed.">                        if(attributeValue instanceof AttributeValue.JointPositions jointPositions){</span>
<span class="nc" id="L76">                            session.addJointPositions(fromDTO(jointPositions));</span>
<span class="nc" id="L77">                            adaptorSessionRepository.save(session);</span>
                        }else {
<span class="nc" id="L79">                            log.warn(&quot;Returned attribute value is not of type JointPositions but of type {}: {}&quot;, attributeValue.getClass().getSimpleName(), attributeValue);</span>
                        }
<span class="nc" id="L81">                    });</span>
<span class="nc" id="L82">        } catch (SessionNotValidException e) {</span>
<span class="nc" id="L83">            log.warn(&quot;Session {} of {} is not valid anymore. Ignoring it until official request from user.&quot;, session.getId(), config.getName());</span>
<span class="nc" id="L84">        }</span>
<span class="nc" id="L85">    }</span>

    private JointPositions fromDTO(AttributeValue.JointPositions jointPositions) {
<span class="nc" id="L88">        return JointPositions.builder()</span>
<span class="nc" id="L89">                .axis1(jointPositions.jointPositions().get(0))</span>
<span class="nc" id="L90">                .axis2(jointPositions.jointPositions().get(1))</span>
<span class="nc" id="L91">                .axis3(jointPositions.jointPositions().get(2))</span>
<span class="nc" id="L92">                .axis4(jointPositions.jointPositions().get(3))</span>
<span class="nc" id="L93">                .axis5(jointPositions.jointPositions().get(4))</span>
<span class="nc" id="L94">                .axis6(jointPositions.jointPositions().get(5))</span>
<span class="nc" id="L95">                .build();</span>
    }
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.7.202105040129</span></div></body></html>