<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>SessionService.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">Adaptor Manager</a> &gt; <a href="index.source.html" class="el_package">at.jku.swe.simcomp.manager.service</a> &gt; <span class="el_source">SessionService.java</span></div><h1>SessionService.java</h1><pre class="source lang-java linenums">package at.jku.swe.simcomp.manager.service;

import at.jku.swe.simcomp.commons.adaptor.endpoint.exception.BadRequestException;
import at.jku.swe.simcomp.commons.adaptor.endpoint.exception.SessionInitializationFailedException;
import at.jku.swe.simcomp.commons.manager.dto.session.SessionRequest;
import at.jku.swe.simcomp.commons.manager.dto.session.SessionRequestVisitor;
import at.jku.swe.simcomp.commons.manager.dto.session.SessionState;
import at.jku.swe.simcomp.commons.manager.dto.session.SessionStateDTO;
import at.jku.swe.simcomp.commons.registry.dto.ServiceRegistrationConfigDTO;
import at.jku.swe.simcomp.manager.domain.model.AdaptorSession;
import at.jku.swe.simcomp.manager.domain.model.Session;
import at.jku.swe.simcomp.manager.domain.repository.AdaptorSessionRepository;
import at.jku.swe.simcomp.manager.domain.repository.SessionRepository;
import at.jku.swe.simcomp.manager.service.client.AdaptorClient;
import at.jku.swe.simcomp.manager.service.client.ServiceRegistryClient;
import lombok.extern.slf4j.Slf4j;
import org.springframework.stereotype.Service;
import org.webjars.NotFoundException;

import java.util.ArrayList;
import java.util.List;
import java.util.Optional;
import java.util.UUID;
import java.util.function.Function;
import java.util.stream.Collectors;

/**
 * This service is responsible for managing sessions {@link Session}.
 */
@Service
<span class="fc" id="L31">@Slf4j</span>
public class SessionService implements SessionRequestVisitor {
    private final SessionRepository sessionRepository;
    private final AdaptorSessionRepository adaptorSessionRepository;
    private final ServiceRegistryClient serviceRegistryClient;
    private final AdaptorClient adaptorClient;

    /**
     * Constructor
     * @param sessionRepository the session repository
     * @param adaptorClient the adaptor client
     * @param serviceRegistryClient the service registry client
     * @param adaptorSessionRepository the adaptor session repository
     */
    public SessionService(SessionRepository sessionRepository,
                          AdaptorClient adaptorClient,
                          ServiceRegistryClient serviceRegistryClient,
<span class="fc" id="L48">                          AdaptorSessionRepository adaptorSessionRepository) {</span>
<span class="fc" id="L49">        this.sessionRepository = sessionRepository;</span>
<span class="fc" id="L50">        this.serviceRegistryClient = serviceRegistryClient;</span>
<span class="fc" id="L51">        this.adaptorClient = adaptorClient;</span>
<span class="fc" id="L52">        this.adaptorSessionRepository = adaptorSessionRepository;</span>
<span class="fc" id="L53">    }</span>

    /**
     * Initializes a session for a given session request.
     * @param request the session request
     * @return the initialized session entity
     * @throws SessionInitializationFailedException if the session could not be initialized
     */
    @Override
    public Session initSession(SessionRequest.SelectedSimulationTypesSessionRequest request) throws SessionInitializationFailedException {
<span class="fc" id="L63">        var adaptorConfigs = getRegisteredAdaptors().stream()</span>
<span class="fc" id="L64">                .filter(config -&gt; request.requestedSimulationTypes().contains(config.getName()))</span>
<span class="fc" id="L65">                .toList();</span>
<span class="fc" id="L66">        log.debug(&quot;Filtered list of available adaptors: {}&quot;, adaptorConfigs);</span>
<span class="fc" id="L67">        return requestAdaptorSessionsAndConstructAndPersistAggregatedSession(adaptorConfigs, Integer.MAX_VALUE);</span>
    }

    /**
     * Initializes a session for a given session request.
     * @param request the session request
     * @return the initialized session entity
     * @throws SessionInitializationFailedException if the session could not be initialized
     */
    @Override
    public Session initSession(SessionRequest.AnySimulationSessionRequest request) throws SessionInitializationFailedException {
<span class="fc" id="L78">        return requestAdaptorSessionsAndConstructAndPersistAggregatedSession(getRegisteredAdaptors(), request.n());</span>
    }

    /**
     * Initializes a session for a given session request.
     * @param request the session request
     * @return the initialized session entity
     * @throws SessionInitializationFailedException if the session could not be initialized
     */
    @Override
    public Session initSession(SessionRequest.SelectedSimulationInstancesSessionRequest request) throws SessionInitializationFailedException {
<span class="fc" id="L89">        var adaptorConfigsToRequestedInstanceId = getRegisteredAdaptors().stream()</span>
<span class="fc" id="L90">                .filter(config -&gt; request.requestedSimulationInstances().containsKey(config.getName()))</span>
<span class="fc" id="L91">                .collect(Collectors.toMap(Function.identity(), config -&gt; request.requestedSimulationInstances().get(config.getName())));</span>

<span class="fc" id="L93">        List&lt;AdaptorSession&gt; sessions = new ArrayList&lt;&gt;();</span>
<span class="fc bfc" id="L94" title="All 2 branches covered.">        for(var entry : adaptorConfigsToRequestedInstanceId.entrySet()){</span>
<span class="fc" id="L95">            Optional&lt;String&gt; sessionKey = adaptorClient.getSession(entry.getKey(), entry.getValue());</span>
<span class="fc" id="L96">            sessionKey.ifPresent(s -&gt; sessions.add(initAdaptorSession(s, entry.getKey().getName(), entry.getValue())));</span>
<span class="fc" id="L97">        }</span>

<span class="fc bfc" id="L99" title="All 2 branches covered.">        if(sessions.isEmpty()){</span>
<span class="fc" id="L100">            throw new SessionInitializationFailedException(&quot;Could not obtain a single session.&quot;);</span>
        }
<span class="fc" id="L102">        var aggregatedSession = constructAggregatedSession(sessions);</span>
<span class="fc" id="L103">        return sessionRepository.save(aggregatedSession);</span>
    }

    /**
     * Closes a session by setting its state to closed.
     * @param aggregatedSessionKey the session id
     * @throws NotFoundException if the session could not be found
     * @throws BadRequestException if the session is already closed
     */
    public void closeSession(UUID aggregatedSessionKey) throws NotFoundException, BadRequestException {
<span class="fc" id="L113">        Session session = sessionRepository.findBySessionKeyOrElseThrow(aggregatedSessionKey);</span>
<span class="pc bpc" id="L114" title="1 of 2 branches missed.">        if(session.getState().equals(SessionState.CLOSED)){</span>
<span class="nc" id="L115">            throw new BadRequestException(&quot;Session %s already closed&quot;.formatted(aggregatedSessionKey));</span>
        }
<span class="fc" id="L117">        closeAdaptorSessions(aggregatedSessionKey);</span>
<span class="fc" id="L118">        sessionRepository.updateSessionStateBySessionKey(aggregatedSessionKey, SessionState.CLOSED);</span>
<span class="fc" id="L119">        log.debug(&quot;Closed session {}&quot;, aggregatedSessionKey.toString());</span>
        //TODO: RESET_TO_HOME before closing adaptor-sessions? Or responsibility of the adaptor?
<span class="fc" id="L121">    }</span>

    /**
     * Returns the state of a session.
     * @param sessionKey the session id
     * @return the session state, including the state of the contained adaptor-sessions.
     * @throws NotFoundException if the session could not be found
     */
    public SessionStateDTO getSessionState(UUID sessionKey) throws NotFoundException{
<span class="fc" id="L130">        Session session = sessionRepository.findBySessionKeyOrElseThrow(sessionKey);</span>
<span class="fc" id="L131">        return new SessionStateDTO(session.getSessionKey().toString(), session.getState(),</span>
<span class="fc" id="L132">                session.getAdaptorSessions().stream()</span>
<span class="pc" id="L133">                        .collect(Collectors.toMap(AdaptorSession::getAdaptorName, AdaptorSession::getState, (state1, state2) -&gt; state1)));</span>

    }

    /**
     * Adds a simulation (=adaptor session) to an existing session.
     * @param sessionKey the session id
     * @param adaptorName the simulation name
     * @throws BadRequestException if the session is already closed or the simulation (type) is already part of the session
     * @throws NotFoundException if the session or the simulation could not be found
     * @throws SessionInitializationFailedException if the simulation (adaptor-session) could not be initialized
     */
    public void addAdaptorSessionToAggregatedSession(UUID sessionKey, String adaptorName) throws BadRequestException, NotFoundException, SessionInitializationFailedException {
<span class="fc" id="L146">        Session session = sessionRepository.findBySessionKeyOrElseThrow(sessionKey);</span>
<span class="pc bpc" id="L147" title="1 of 2 branches missed.">        if(session.getState().equals(SessionState.CLOSED)){</span>
<span class="nc" id="L148">            throw new BadRequestException(&quot;Session %s already closed&quot;.formatted(sessionKey));</span>
        }
<span class="pc bpc" id="L150" title="1 of 2 branches missed.">        if(session.getAdaptorSessions().stream().map(AdaptorSession::getAdaptorName).anyMatch(name -&gt; name.equals(adaptorName))){</span>
<span class="nc" id="L151">            throw new BadRequestException(&quot;Simulation %s already part of session %s. You can manually close and reopen the simulation-session to initialize a new simulation-session&quot;.formatted(adaptorName, sessionKey));</span>
        }

<span class="fc" id="L154">        var adaptorConfigs = getRegisteredAdaptors().stream()</span>
<span class="fc" id="L155">                .filter(config -&gt; config.getName().equals(adaptorName))</span>
<span class="fc" id="L156">                .toList();</span>

<span class="fc bfc" id="L158" title="All 2 branches covered.">        if(adaptorConfigs.isEmpty()) {</span>
<span class="fc" id="L159">            throw new NotFoundException(&quot;Simulation %s not registered&quot;.formatted(adaptorName));</span>
        }

<span class="fc" id="L162">        var optAdaptorSessionKey = adaptorClient.getSession(adaptorConfigs.get(0));</span>

<span class="fc bfc" id="L164" title="All 2 branches covered.">        if(optAdaptorSessionKey.isEmpty()){</span>
<span class="fc" id="L165">            throw new SessionInitializationFailedException(&quot;Could not obtain session for simulation %s&quot;.formatted(adaptorName));</span>
        }

<span class="fc" id="L168">        AdaptorSession adaptorSession = initAdaptorSession(optAdaptorSessionKey.get(), adaptorName, null);</span>
<span class="fc" id="L169">        session.addAdaptorSession(adaptorSession);</span>
<span class="fc" id="L170">        sessionRepository.save(session);</span>
<span class="fc" id="L171">    }</span>

    /**
     * Removes a simulation (=adaptor session) from an existing session.
     * @param sessionKey the session id
     * @param adaptorName the simulation name
     * @throws BadRequestException if the session is already closed or the simulation (type) is not part of the session, or the adaptor-session is already closed
     * @throws NotFoundException if the session could not be found
     */
    public void closeAdaptorSessionOfAggregateSession(UUID sessionKey, String adaptorName) throws BadRequestException, NotFoundException {
<span class="fc" id="L181">        Session session = sessionRepository.findBySessionKeyOrElseThrow(sessionKey);</span>
<span class="pc bpc" id="L182" title="1 of 2 branches missed.">        if(session.getState().equals(SessionState.CLOSED)){</span>
<span class="nc" id="L183">            throw new BadRequestException(&quot;Session %s already closed&quot;.formatted(sessionKey));</span>
        }
<span class="fc" id="L185">        AdaptorSession adaptorSession = session.getAdaptorSessions().stream()</span>
<span class="fc" id="L186">                .filter(adaptorSession1 -&gt; adaptorSession1.getAdaptorName().equals(adaptorName))</span>
<span class="fc" id="L187">                .findFirst()</span>
<span class="fc" id="L188">                .orElseThrow(() -&gt; new BadRequestException(&quot;Simulation %s not part of session %s&quot;.formatted(adaptorName, sessionKey)));</span>

<span class="pc bpc" id="L190" title="1 of 2 branches missed.">        if(adaptorSession.getState() == SessionState.CLOSED){</span>
<span class="nc" id="L191">            throw new BadRequestException(&quot;Simulation %s already closed&quot;.formatted(adaptorName));</span>
        }
<span class="fc" id="L193">        closeAdaptorSession(adaptorSession, getRegisteredAdaptors());</span>
<span class="fc" id="L194">    }</span>

    /**
     * Reopens a simulation (=adaptor session) from an existing session.
     * @param sessionKey the session id
     * @param adaptorName the simulation name
     * @throws BadRequestException if the session is already closed or the simulation (type) is not part of the session, or the adaptor-session is already open
     * @throws NotFoundException if the session could not be found
     * @throws SessionInitializationFailedException if the simulation (adaptor-session) could not be initialized
     */
    public void reopenAdaptorSessionOfAggregateSession(UUID sessionKey, String adaptorName) throws BadRequestException, SessionInitializationFailedException {
<span class="fc" id="L205">        Session session = sessionRepository.findBySessionKeyOrElseThrow(sessionKey);</span>
<span class="pc bpc" id="L206" title="1 of 2 branches missed.">        if(session.getState().equals(SessionState.CLOSED)){</span>
<span class="nc" id="L207">            throw new BadRequestException(&quot;Session %s already closed&quot;.formatted(sessionKey));</span>
        }
<span class="fc" id="L209">        AdaptorSession adaptorSession = session.getAdaptorSessions().stream()</span>
<span class="fc" id="L210">                .filter(adaptorSession1 -&gt; adaptorSession1.getAdaptorName().equals(adaptorName))</span>
<span class="fc" id="L211">                .findFirst()</span>
<span class="fc" id="L212">                .orElseThrow(() -&gt; new BadRequestException(&quot;Simulation %s not part of session %s&quot;.formatted(adaptorName, sessionKey)));</span>

<span class="pc bpc" id="L214" title="1 of 2 branches missed.">        if(adaptorSession.getState().equals(SessionState.OPEN)){</span>
<span class="nc" id="L215">            throw new BadRequestException(&quot;Simulation %s already open. Close it before trying to reopen a new one&quot;.formatted(adaptorName));</span>
        }

<span class="fc" id="L218">        var adaptorConfigs = getRegisteredAdaptors().stream()</span>
<span class="fc" id="L219">                .filter(config -&gt; config.getName().equals(adaptorName))</span>
<span class="fc" id="L220">                .toList();</span>

<span class="pc bpc" id="L222" title="1 of 2 branches missed.">        if(adaptorConfigs.isEmpty()) {</span>
<span class="nc" id="L223">            throw new SessionInitializationFailedException(&quot;Simulation %s not registered&quot;.formatted(adaptorName));</span>
        }

<span class="fc" id="L226">        Optional&lt;String&gt; optAdaptorSessionKey = Optional.empty();</span>
<span class="pc bpc" id="L227" title="1 of 2 branches missed.">        if(adaptorSession.getInstanceId() != null){</span>
<span class="nc" id="L228">            optAdaptorSessionKey = adaptorClient.getSession(adaptorConfigs.get(0), adaptorSession.getInstanceId());</span>
        }else{
<span class="fc" id="L230">            optAdaptorSessionKey = adaptorClient.getSession(adaptorConfigs.get(0));</span>
        }

<span class="pc bpc" id="L233" title="1 of 2 branches missed.">        if(optAdaptorSessionKey.isEmpty()){</span>
<span class="nc" id="L234">            throw new SessionInitializationFailedException(&quot;Could not obtain session for instance %s of simulation %s&quot;.formatted(adaptorSession.getInstanceId(), adaptorName));</span>
        }

<span class="fc" id="L237">        adaptorSession.setSessionKey(optAdaptorSessionKey.get());</span>
<span class="fc" id="L238">        adaptorSession.setState(SessionState.OPEN);</span>
<span class="fc" id="L239">        sessionRepository.save(session);</span>
        // TODO: reconstruct latest known state of adaptor session
<span class="fc" id="L241">    }</span>

    // private region methods
    private Session requestAdaptorSessionsAndConstructAndPersistAggregatedSession(List&lt;ServiceRegistrationConfigDTO&gt; adaptorConfigs, Integer maximumNumberOfSimulations) throws SessionInitializationFailedException {
<span class="fc" id="L245">        var acquiredSessions = tryObtainAdaptorSessions(adaptorConfigs, maximumNumberOfSimulations);</span>
<span class="fc" id="L246">        var aggregatedSession = constructAggregatedSession(acquiredSessions);</span>
<span class="fc" id="L247">        return sessionRepository.save(aggregatedSession);</span>
    }

    private List&lt;AdaptorSession&gt; tryObtainAdaptorSessions(List&lt;ServiceRegistrationConfigDTO&gt; requestedSimulations, int maximumSimulations){
<span class="fc" id="L251">        List&lt;AdaptorSession&gt; sessions = new ArrayList&lt;&gt;();</span>
<span class="fc bfc" id="L252" title="All 2 branches covered.">        for(var config : requestedSimulations){</span>
<span class="pc bpc" id="L253" title="1 of 2 branches missed.">            if(sessions.size() &gt;= maximumSimulations)</span>
<span class="nc" id="L254">                break;</span>

<span class="fc" id="L256">            tryAddAdaptorSession(config, sessions);</span>
<span class="fc" id="L257">        }</span>
<span class="fc" id="L258">        return sessions;</span>
    }

    private void tryAddAdaptorSession(ServiceRegistrationConfigDTO config, List&lt;AdaptorSession&gt; sessions) {
<span class="fc" id="L262">        Optional&lt;String&gt; sessionKey = adaptorClient.getSession(config);</span>
<span class="fc" id="L263">        sessionKey.ifPresent(s -&gt; sessions.add(initAdaptorSession(s, config.getName(), null)));</span>
<span class="fc" id="L264">    }</span>

    private Session constructAggregatedSession(List&lt;AdaptorSession&gt; adaptorSessions) throws SessionInitializationFailedException {
<span class="fc bfc" id="L267" title="All 2 branches covered.">        if(adaptorSessions.isEmpty()){</span>
<span class="fc" id="L268">            throw new SessionInitializationFailedException(&quot;Could not obtain a single session&quot;);</span>
        }
<span class="fc" id="L270">        log.debug(&quot;Aggregating adaptor sessions: {}&quot;, adaptorSessions);</span>
<span class="fc" id="L271">        Session session = initNewSessionWithUUID();</span>
<span class="fc" id="L272">        adaptorSessions.forEach(session::addAdaptorSession);</span>
<span class="fc" id="L273">        log.debug(&quot;Aggregated session: {}&quot;, session);</span>
<span class="fc" id="L274">        return session;</span>
    }

    private Session initNewSessionWithUUID() {
<span class="fc" id="L278">        return Session.builder()</span>
<span class="fc" id="L279">                .sessionKey(UUID.randomUUID())</span>
<span class="fc" id="L280">                .state(SessionState.OPEN)</span>
<span class="fc" id="L281">                .build();</span>
    }

    private AdaptorSession initAdaptorSession(String key, String name, String instanceId){
<span class="fc" id="L285">        return AdaptorSession.builder()</span>
<span class="fc" id="L286">                .sessionKey(key)</span>
<span class="fc" id="L287">                .adaptorName(name)</span>
<span class="fc" id="L288">                .instanceId(instanceId)</span>
<span class="fc" id="L289">                .state(SessionState.OPEN)</span>
<span class="fc" id="L290">                .build();</span>
    }

    private List&lt;ServiceRegistrationConfigDTO&gt; getRegisteredAdaptors() {
<span class="fc" id="L294">        return serviceRegistryClient.getRegisteredAdaptors();</span>
    }

    private void closeAdaptorSessions(UUID aggregatedSessionKey) {
<span class="fc" id="L298">        var adaptorConfigs = getRegisteredAdaptors();</span>
<span class="fc bfc" id="L299" title="All 2 branches covered.">        for(var adaptorSession : adaptorSessionRepository.findBySessionSessionKey(aggregatedSessionKey)){</span>
<span class="fc" id="L300">            closeAdaptorSession(adaptorSession, adaptorConfigs);</span>
<span class="fc" id="L301">        }</span>
<span class="fc" id="L302">    }</span>

    private void closeAdaptorSession(AdaptorSession adaptorSession, List&lt;ServiceRegistrationConfigDTO&gt; adaptorConfigs){
<span class="fc" id="L305">        adaptorConfigs.stream()</span>
<span class="fc" id="L306">                .filter(config -&gt; config.getName().equals(adaptorSession.getAdaptorName()))</span>
<span class="fc" id="L307">                .findFirst()</span>
<span class="fc" id="L308">                .ifPresent(serviceRegistrationConfigDTO -&gt; adaptorClient.closeSession(serviceRegistrationConfigDTO, adaptorSession.getSessionKey()));</span>
<span class="fc" id="L309">        adaptorSessionRepository.updateSessionStateById(adaptorSession.getId(), SessionState.CLOSED);</span>
<span class="fc" id="L310">    }</span>

}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.7.202105040129</span></div></body></html>