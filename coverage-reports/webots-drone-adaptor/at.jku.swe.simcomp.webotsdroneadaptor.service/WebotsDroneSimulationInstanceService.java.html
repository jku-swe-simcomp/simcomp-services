<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>WebotsDroneSimulationInstanceService.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">webots-drone-adaptor</a> &gt; <a href="index.source.html" class="el_package">at.jku.swe.simcomp.webotsdroneadaptor.service</a> &gt; <span class="el_source">WebotsDroneSimulationInstanceService.java</span></div><h1>WebotsDroneSimulationInstanceService.java</h1><pre class="source lang-java linenums">package at.jku.swe.simcomp.webotsdroneadaptor.service;

import at.jku.swe.simcomp.commons.adaptor.endpoint.exception.BadRequestException;
import at.jku.swe.simcomp.commons.adaptor.endpoint.simulation.SimulationInstanceConfig;
import at.jku.swe.simcomp.commons.adaptor.endpoint.simulation.SimulationInstanceService;
import at.jku.swe.simcomp.webotsdroneadaptor.domain.simulation.DroneInstanceRemovalListener;
import org.apache.logging.log4j.LogManager;
import org.apache.logging.log4j.Logger;
import org.springframework.beans.factory.annotation.Value;
import org.springframework.stereotype.Service;

import java.util.Collections;
import java.util.HashSet;
import java.util.Optional;
import java.util.Set;

/**
 * The class keeps track of the all simulation instances registered
 * for the Webots adapter. The class contains a set of all simulations
 * and allows to add and remove instances. The class contains a static
 * set of
 * @see SimulationInstanceConfig and
 * @see DroneInstanceRemovalListener
 */
@Service
public class WebotsDroneSimulationInstanceService implements SimulationInstanceService {
<span class="fc" id="L27">    private static final Logger log = LogManager.getLogger();</span>
<span class="fc" id="L28">    private static final Set&lt;DroneInstanceRemovalListener&gt; SIMULATION_INSTANCE_REMOVAL_LISTENERS = Collections.synchronizedSet(new HashSet&lt;&gt;());</span>
<span class="fc" id="L29">    private static final Set&lt;SimulationInstanceConfig&gt; INSTANCES = Collections.synchronizedSet(new HashSet&lt;&gt;());</span>
    private final String adaptorName;

    /**
     * Creates a new instance, the value of the adaptor name must
     * be equal to WEBOTS
     * @param adaptorName the name of the adaptor
     */
<span class="fc" id="L37">    public WebotsDroneSimulationInstanceService(@Value(&quot;${adaptor.endpoint.name}&quot;) String adaptorName) {</span>
<span class="fc" id="L38">       this.adaptorName = adaptorName;</span>
<span class="fc" id="L39">    }</span>

    /**
     * Method to add a new simulation instance based on a configuration.
     * The method checks, if the simulation is of type Webots, and if
     * instanceID, host and port a new.
     * @param config Configuration with the simulation name, simulation
     *               type, host and port
     * @throws BadRequestException gets thrown if the simulation instance
     * has the wrong type, the host and port a already used, or the instance
     * ID already exists.
     */
    @Override
    public void addSimulationInstance(SimulationInstanceConfig config) throws BadRequestException {
<span class="fc bfc" id="L53" title="All 2 branches covered.">        if(!config.getSimulationType().equals(this.adaptorName)){</span>
<span class="fc" id="L54">            throw new BadRequestException(&quot;Simulation name does not match the name of this adaptor&quot;);</span>
        }
<span class="fc bfc" id="L56" title="All 4 branches covered.">        if(INSTANCES.stream().anyMatch(instance -&gt; instance.getInstanceHost().equals(config.getInstanceHost()) &amp;&amp;</span>
<span class="pc bpc" id="L57" title="1 of 2 branches missed.">                instance.getInstancePort().equals(config.getInstancePort()))){</span>
<span class="fc" id="L58">            throw new BadRequestException(&quot;Simulation instance with same host and port already exists&quot;);</span>
        }
<span class="fc bfc" id="L60" title="All 2 branches covered.">        if(INSTANCES.stream().anyMatch(instance -&gt; instance.getInstanceId().equals(config.getInstanceId()))){</span>
<span class="fc" id="L61">            throw new BadRequestException(&quot;Simulation instance with same id already exists&quot;);</span>
        }
<span class="fc" id="L63">        INSTANCES.add(config);</span>
<span class="fc" id="L64">        log.info(&quot;Added simulation instance: {}&quot;, config);</span>
<span class="fc" id="L65">    }</span>

    /**
     * Removes a simulation instance from the set of instance, and
     * calls the simulation removal listener that the instance got removed.
     * @param instanceId the ID of the instance to remove.
     */
    @Override
    public void removeSimulationInstance(String instanceId) {
<span class="fc" id="L74">        Optional&lt;SimulationInstanceConfig&gt; config = INSTANCES.stream().filter(simulation -&gt; simulation.getInstanceId().equals(instanceId)).findFirst();</span>
<span class="fc bfc" id="L75" title="All 2 branches covered.">        if(config.isPresent()){</span>
<span class="fc" id="L76">            INSTANCES.remove(config.get());</span>
<span class="fc" id="L77">            notifySimulationRemovalListeners(config.get());</span>
<span class="fc" id="L78">            log.info(&quot;Removed simulation: {}&quot;, config.get());</span>
        }else {
<span class="fc" id="L80">            log.info(&quot;Simulation instance {} not found&quot;, instanceId);</span>
        }
<span class="fc" id="L82">    }</span>

    /**
     * Nonstatic method to return the set of instances.
     * @return the set of instances.
     */
    @Override
    public Set&lt;SimulationInstanceConfig&gt; getSimulationInstances() {
<span class="fc" id="L90">        return INSTANCES;</span>
    }

    /**
     * Adds a new removal listener to the static set of removal listeners.
     * @param listener the new removal listener to add
     */
    public void addSimulationRemovalListener(DroneInstanceRemovalListener listener) {
<span class="fc" id="L98">        SIMULATION_INSTANCE_REMOVAL_LISTENERS.add(listener);</span>
<span class="fc" id="L99">        log.info(&quot;Added simulation instance removal listener: {}&quot;, listener);</span>
<span class="fc" id="L100">    }</span>

    /**
     * Notifies alls removal listener that a simulation instance was removed.
     * @param config the simulation instance that was removed.
     */
    public void notifySimulationRemovalListeners(SimulationInstanceConfig config) {
<span class="fc" id="L107">        SIMULATION_INSTANCE_REMOVAL_LISTENERS.forEach(listener -&gt; listener.onSimulationRemoved(config));</span>
<span class="fc" id="L108">        log.info(&quot;Notified simulation instance removal listeners about removal of: {}&quot;, config);</span>
<span class="fc" id="L109">    }</span>

    /**
     * Static method to return the set of instances.
     * @return the set of instances.
     */
    public static Set&lt;SimulationInstanceConfig&gt; getInstances() {
<span class="fc" id="L116">        return INSTANCES;</span>
    }
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.7.202105040129</span></div></body></html>