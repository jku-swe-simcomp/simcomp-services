<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>AsyncCommandDistributionService.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">Adaptor Manager</a> &gt; <a href="index.source.html" class="el_package">at.jku.swe.simcomp.manager.service</a> &gt; <span class="el_source">AsyncCommandDistributionService.java</span></div><h1>AsyncCommandDistributionService.java</h1><pre class="source lang-java linenums">package at.jku.swe.simcomp.manager.service;

import at.jku.swe.simcomp.commons.adaptor.dto.ExecutionResultDTO;
import at.jku.swe.simcomp.commons.adaptor.endpoint.exception.SessionNotValidException;
import at.jku.swe.simcomp.commons.adaptor.execution.command.ExecutionCommand;
import at.jku.swe.simcomp.commons.adaptor.execution.command.visitor.impl.ExecutionCommandValidationVisitor;
import at.jku.swe.simcomp.commons.manager.dto.execution.ExecutionResponseState;
import at.jku.swe.simcomp.commons.manager.dto.session.SessionState;
import at.jku.swe.simcomp.commons.registry.dto.ServiceRegistrationConfigDTO;
import at.jku.swe.simcomp.manager.domain.model.AdaptorSession;
import at.jku.swe.simcomp.manager.domain.model.ExecutionResponse;
import at.jku.swe.simcomp.manager.domain.repository.AdaptorSessionRepository;
import at.jku.swe.simcomp.manager.domain.repository.ExecutionRepository;
import at.jku.swe.simcomp.manager.domain.repository.ExecutionResponseRepository;
import at.jku.swe.simcomp.manager.rest.exception.CommandExecutionFailedException;
import at.jku.swe.simcomp.manager.service.client.AdaptorClient;
import lombok.NonNull;
import lombok.extern.slf4j.Slf4j;
import org.springframework.scheduling.annotation.Async;
import org.springframework.stereotype.Service;

import java.util.UUID;

@Service
<span class="fc" id="L25">@Slf4j</span>
public class AsyncCommandDistributionService {
    private final AdaptorClient adaptorClient;
    private final ExecutionRepository executionRepository;
    private final ExecutionResponseRepository executionResponseRepository;
    private final AdaptorSessionRepository adaptorSessionRepository;
    private final ExecutionCommandValidationVisitor executionCommandValidationVisitor;

    public AsyncCommandDistributionService(ExecutionRepository executionRepository,
                                           AdaptorClient adaptorClient,
                                           ExecutionResponseRepository executionResponseRepository,
                                           AdaptorSessionRepository adaptorSessionRepository,
<span class="fc" id="L37">                                           ExecutionCommandValidationVisitor executionCommandValidationVisitor) {</span>
<span class="fc" id="L38">        this.executionRepository = executionRepository;</span>
<span class="fc" id="L39">        this.adaptorClient = adaptorClient;</span>
<span class="fc" id="L40">        this.executionResponseRepository = executionResponseRepository;</span>
<span class="fc" id="L41">        this.adaptorSessionRepository = adaptorSessionRepository;</span>
<span class="fc" id="L42">        this.executionCommandValidationVisitor = executionCommandValidationVisitor;</span>
<span class="fc" id="L43">    }</span>
    @Async
<span class="pc bpc" id="L45" title="1 of 2 branches missed.">    public void distributeCommand(@NonNull Long adaptorSessionId,</span>
<span class="pc bpc" id="L46" title="1 of 2 branches missed.">                                  @NonNull UUID executionId,</span>
<span class="pc bpc" id="L47" title="1 of 2 branches missed.">                                  @NonNull ServiceRegistrationConfigDTO serviceRegistrationConfig,</span>
<span class="pc bpc" id="L48" title="1 of 2 branches missed.">                                  @NonNull ExecutionCommand command) {</span>
<span class="fc" id="L49">        AdaptorSession adaptorSession = adaptorSessionRepository.findById(adaptorSessionId)</span>
<span class="fc" id="L50">                .orElseThrow();</span>

<span class="fc bfc" id="L52" title="All 2 branches covered.">        if(adaptorSession.getState().equals(SessionState.CLOSED)){</span>
<span class="fc" id="L53">            log.info(&quot;Ignoring closed adaptor-session {}&quot;, adaptorSession.getId());</span>
<span class="fc" id="L54">            return;</span>
        }

<span class="fc" id="L57">        Long responseId = initDefaultExecutionResponse(adaptorSession, executionId);</span>

        try {
<span class="fc bfc" id="L60" title="All 2 branches covered.">            if(Boolean.FALSE.equals(command.accept(executionCommandValidationVisitor, serviceRegistrationConfig.getSupportedActions()))){</span>
<span class="fc" id="L61">                log.warn(&quot;Command {} not supported by {}. Aborting.&quot;, command, serviceRegistrationConfig);</span>
<span class="fc" id="L62">                updateExecutionResponse(responseId, 400, &quot;Command was not even distributed to simulation as the simulation indicated it does not support at least one of the attempted actions.&quot;, ExecutionResponseState.ERROR);</span>
<span class="fc" id="L63">                return;</span>
            }
<span class="nc" id="L65">        } catch (Exception e) {</span>
<span class="nc" id="L66">            log.info(&quot;Command validation threw exception: {}. Continuing with distribution nevertheless..&quot;, e.getMessage());</span>
<span class="fc" id="L67">        }</span>

<span class="fc" id="L69">        log.info(&quot;Distributing command {} to adaptor-session {}&quot;, executionId, adaptorSession.getAdaptorName());</span>
        try {
<span class="fc" id="L71">            sendCommandAndUpdateResponse(responseId, serviceRegistrationConfig, command, adaptorSession.getSessionKey());</span>
<span class="fc" id="L72">        } catch (SessionNotValidException e) {</span>
<span class="fc" id="L73">            log.info(&quot;Marking simulation session %s from aggregate session %s as closed, as it returned 401 unauthorized.&quot;.formatted(adaptorSession.getAdaptorName(), adaptorSession.getSession().getSessionKey()));</span>
<span class="fc" id="L74">            adaptorSessionRepository.updateSessionStateBySessionKey(adaptorSessionId, SessionState.CLOSED);</span>
<span class="fc" id="L75">        }</span>
<span class="fc" id="L76">    }</span>

    // private region methods

    private void sendCommandAndUpdateResponse(Long responseId,
                                              ServiceRegistrationConfigDTO serviceRegistrationConfig,
                                              ExecutionCommand command,
                                              String adaptorSessionKey) throws SessionNotValidException {
        try{
<span class="fc" id="L85">            ExecutionResultDTO executionResult = adaptorClient.executeCommand(serviceRegistrationConfig, command, adaptorSessionKey);</span>
<span class="fc" id="L86">            updateExecutionResponse(responseId, 200, executionResult.getReport(), ExecutionResponseState.SUCCESS);</span>
<span class="fc" id="L87">            log.info(&quot;Execution of command for adaptor-session {} finished: {}. &quot;, serviceRegistrationConfig.getName(), executionResult);</span>
<span class="fc" id="L88">        }catch (CommandExecutionFailedException e){</span>
<span class="fc" id="L89">            log.error(&quot;Execution of command failed for adaptor-session {}&quot;, serviceRegistrationConfig.getName());</span>
<span class="fc" id="L90">            updateExecutionResponse(responseId, e.getCode(), e.getMessage(), ExecutionResponseState.ERROR);</span>
<span class="pc bpc" id="L91" title="1 of 2 branches missed.">            if(e.getCode() == 401){</span>
<span class="fc" id="L92">                throw new SessionNotValidException(&quot;&quot;);</span>
            }
<span class="fc" id="L94">        }</span>
<span class="fc" id="L95">    }</span>

    private Long initDefaultExecutionResponse(AdaptorSession adaptorSession,
                                                           UUID executionId) {
<span class="fc" id="L99">        ExecutionResponse executionResponse = ExecutionResponse.builder()</span>
<span class="fc" id="L100">                .adaptorSession(adaptorSession)</span>
<span class="fc" id="L101">                .execution(executionRepository.findByExecutionUUIDOrElseThrow(executionId))</span>
<span class="fc" id="L102">                .state(ExecutionResponseState.RUNNING)</span>
<span class="fc" id="L103">                .build();</span>
<span class="fc" id="L104">        executionResponse = executionResponseRepository.save(executionResponse);</span>
<span class="fc" id="L105">        executionRepository.flush();</span>
<span class="fc" id="L106">        return executionResponse.getId();</span>
    }

    private void updateExecutionResponse(Long executionResponseId,
                                         Integer code,
                                         String message,
                                         ExecutionResponseState state) {
<span class="fc" id="L113">        executionResponseRepository.updateExecutionResponse(executionResponseId, code, state, message);</span>
<span class="fc" id="L114">    }</span>

}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.7.202105040129</span></div></body></html>